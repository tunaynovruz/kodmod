---
title: Cross-Site Request Forgery (CSRF)
sidebar_label: CSRF
description: CSRF hücumları və müdafiə metodları
slug: security/csrf
tags: [csrf, security, web-security, token, protection]
keywords: [csrf, cross-site request forgery, təhlükəsizlik, token, saxtakarlıq]
hide_table_of_contents: false
---

# Cross-Site Request Forgery (CSRF)

- **CSRF Hücumu:** İstifadəçinin xəbəri olmadan onun adından zərərli sorğular göndərilməsi.
- **Güvənilən İstifadəçi:** Hücumçu artıq authenticate olmuş istifadəçinin sessiyasından istifadə edir.
- **State Dəyişikliyi:** Əsasən POST, PUT, DELETE kimi state dəyişdirən əməliyyatları hədəfləyir.
- **Same-Origin Policy:** Browser-lərin təbii müdafiəsi, lakin form submit-lər üçün məhdud.
- **CSRF Token:** Hər form üçün təsadüfi, unikal token generasiya edilir.

## CSRF Hücumunun Mexanizmi

### 1. Hücumun Addımları
1. İstifadəçi bank saytına login olur
2. Hücumçu saytına daxil olur
3. Zərərli sayt gizli form göndərir
4. Bank saytı istifadəçinin cookie-ləri ilə sorğunu qəbul edir
5. Pul köçürmə əməliyyatı aparılır

### 2. Hücum Nümunəsi

**Zərərli HTML:**
```html
<!-- Gizli form -->
<form action="https://bank.com/transfer" method="POST" id="maliciousForm">
    <input type="hidden" name="to" value="attacker_account">
    <input type="hidden" name="amount" value="1000">
</form>

<script>
    // Avtomatik submit
    document.getElementById('maliciousForm').submit();
</script>
```

**Image ilə GET Request:**
```html
<img src="https://bank.com/delete-account?confirm=yes" style="display:none">
```

**AJAX ilə:**
```javascript
fetch('https://vulnerable-site.com/api/delete', {
    method: 'POST',
    credentials: 'include', // Cookie-lər daxil edilir
    body: JSON.stringify({id: 123})
});
```

## CSRF Müdafiə Metodları

### 1. CSRF Token (Synchronizer Token Pattern)

**Token Generasiyası:**
```java
// Spring Security
@Controller
public class BankController {
    
    @GetMapping("/transfer")
    public String transferForm(Model model, HttpServletRequest request) {
        // CSRF token avtomatik əlavə edilir
        return "transfer";
    }
    
    @PostMapping("/transfer")
    public String processTransfer(@RequestParam String amount,
                                 @RequestParam String to) {
        // Token avtomatik yoxlanılır
        return "success";
    }
}
```

**HTML Form:**
```html
<form action="/transfer" method="post">
    <input type="hidden" name="_token" value="${_csrf.token}">
    <input type="text" name="amount" placeholder="Məbləğ">
    <input type="text" name="to" placeholder="Hesab">
    <input type="submit" value="Köçür">
</form>
```

### 2. Double Submit Cookie Pattern

**Implementation:**
```java
@Component
public class CSRFTokenFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        
        if ("POST".equals(req.getMethod())) {
            String cookieToken = getCsrfCookie(req);
            String headerToken = req.getHeader("X-CSRF-TOKEN");
            
            if (!Objects.equals(cookieToken, headerToken)) {
                throw new SecurityException("CSRF token mismatch");
            }
        }
        
        chain.doFilter(request, response);
    }
}
```

**Frontend JavaScript:**
```javascript
// Cookie-dən token oxu
function getCsrfToken() {
    return document.cookie
        .split('; ')
        .find(row => row.startsWith('csrf-token='))
        ?.split('=')[1];
}

// AJAX sorğularında istifadə et
fetch('/api/transfer', {
    method: 'POST',
    headers: {
        'X-CSRF-TOKEN': getCsrfToken(),
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({amount: 100, to: 'account123'})
});
```

### 3. SameSite Cookie Attribute

**Konfiqurasiya:**
```java
// Spring Boot application.properties
server.servlet.session.cookie.same-site=strict

// Və ya programmatik
@Bean
public CookieSameSiteSupplier cookieSameSiteSupplier() {
    return CookieSameSiteSupplier.ofStrict();
}
```

**Cookie Növləri:**
```http
Set-Cookie: sessionid=abc123; SameSite=Strict  // Ən sərt
Set-Cookie: sessionid=abc123; SameSite=Lax     // Orta
Set-Cookie: sessionid=abc123; SameSite=None    // Heç bir məhdudiyyət
```

### 4. Origin/Referer Header Yoxlanışı

**Spring Security:**
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf
            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            .requireCsrfProtectionMatcher(request -> 
                !"GET".equals(request.getMethod()) && 
                !"/api/public".equals(request.getRequestURI())
            )
        );
        return http.build();
    }
}
```

**Manuel Origin Yoxlanışı:**
```java
@Component
public class OriginValidationFilter implements Filter {
    
    private static final List<String> ALLOWED_ORIGINS = Arrays.asList(
        "https://mysite.com",
        "https://www.mysite.com"
    );
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        String origin = req.getHeader("Origin");
        String referer = req.getHeader("Referer");
        
        if (isStateChangingRequest(req)) {
            if (!isValidOrigin(origin) && !isValidReferer(referer)) {
                throw new SecurityException("Invalid origin");
            }
        }
        
        chain.doFilter(request, response);
    }
    
    private boolean isValidOrigin(String origin) {
        return origin != null && ALLOWED_ORIGINS.contains(origin);
    }
}
```

## Framework-specific Tətbiq

### Spring Boot

**1. Avtomatik CSRF Qorunması:**
```java
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                .ignoringRequestMatchers("/api/public/**")
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            );
        return http.build();
    }
}
```

**2. Thymeleaf Template:**
```html
<form th:action="@{/transfer}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <!-- Form fieldləri -->
</form>
```

### React/Next.js

**1. CSRF Token Hook:**
```javascript
import { useEffect, useState } from 'react';

export function useCSRFToken() {
    const [token, setToken] = useState(null);
    
    useEffect(() => {
        fetch('/api/csrf-token')
            .then(res => res.json())
            .then(data => setToken(data.token));
    }, []);
    
    return token;
}
```

**2. API Calls:**
```javascript
function TransferComponent() {
    const csrfToken = useCSRFToken();
    
    const handleTransfer = async (formData) => {
        const response = await fetch('/api/transfer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error('Transfer failed');
        }
    };
    
    return (
        <form onSubmit={handleSubmit}>
            {/* Form elementləri */}
        </form>
    );
}
```

## REST API-lər üçün CSRF

### Stateless JWT Authentication

**JWT ilə CSRF lazım deyil:**
```java
@RestController
public class ApiController {
    
    @PostMapping("/api/transfer")
    public ResponseEntity<String> transfer(
            @RequestHeader("Authorization") String token,
            @RequestBody TransferRequest request) {
        
        // JWT token yoxlanılır
        if (!jwtService.validateToken(token)) {
            return ResponseEntity.status(401).body("Invalid token");
        }
        
        // CSRF token lazım deyil
        return ResponseEntity.ok("Transfer completed");
    }
}
```

### API Key Authentication

**API Key ilə CSRF:**
```java
@RestController
public class ApiController {
    
    @PostMapping("/api/transfer")
    public ResponseEntity<String> transfer(
            @RequestHeader("X-API-KEY") String apiKey,
            @RequestHeader("X-CSRF-TOKEN") String csrfToken,
            @RequestBody TransferRequest request) {
        
        if (!apiKeyService.validate(apiKey)) {
            return ResponseEntity.status(401).body("Invalid API key");
        }
        
        if (!csrfService.validateToken(csrfToken)) {
            return ResponseEntity.status(403).body("CSRF token invalid");
        }
        
        return ResponseEntity.ok("Transfer completed");
    }
}
```

## Test və Debugging

### CSRF Test

**1. Zəiflik Test:**
```bash
# CSRF token olmadan sorğu göndər
curl -X POST http://localhost:8080/transfer \
  -H "Cookie: JSESSIONID=ABC123" \
  -d "amount=1000&to=attacker" \
  -H "Content-Type: application/x-www-form-urlencoded"
```

**2. Burp Suite ilə Test:**
- Intercept request
- CSRF token-i sil
- Request-i təkrarla göndər
- 403 Forbidden almalısan

### Debug CSRF Issues

**1. Token Debugging:**
```java
@Controller
public class DebugController {
    
    @GetMapping("/debug/csrf")
    @ResponseBody
    public Map<String, Object> debugCSRF(HttpServletRequest request) {
        CsrfToken token = (CsrfToken) request.getAttribute("_csrf");
        
        Map<String, Object> debug = new HashMap<>();
        debug.put("token", token.getToken());
        debug.put("headerName", token.getHeaderName());
        debug.put("parameterName", token.getParameterName());
        
        return debug;
    }
}
```

**2. Frontend Debugging:**
```javascript
// Browser console-də
console.log('CSRF Token:', document.querySelector('[name="_csrf"]')?.value);
console.log('Cookies:', document.cookie);
```

## Best Practice-lər

### 1. Defense in Depth
- CSRF token + SameSite cookie
- Origin/Referer yoxlanışı
- Rate limiting
- User interaction requirement

### 2. Token Management
```java
// Token rotation
@Service
public class CSRFTokenService {
    
    public String generateToken() {
        return UUID.randomUUID().toString();
    }
    
    public boolean validateAndRefresh(String token, HttpSession session) {
        String sessionToken = (String) session.getAttribute("csrf_token");
        boolean valid = Objects.equals(token, sessionToken);
        
        if (valid) {
            // Yeni token generasiya et
            session.setAttribute("csrf_token", generateToken());
        }
        
        return valid;
    }
}
```

### 3. Error Handling
```java
@ControllerAdvice
public class CSRFExceptionHandler {
    
    @ExceptionHandler(InvalidCsrfTokenException.class)
    public ResponseEntity<String> handleCSRFException(InvalidCsrfTokenException ex) {
        return ResponseEntity.status(403).body("CSRF token invalid. Please refresh the page.");
    }
}
```

CSRF müdafiəsi veb tətbiqlərinin təhlükəsizliyi üçün vacibdir və düzgün tətbiq edilməlidir.
